# Release v0.4.1

**Investment Memo Orchestrator** - Multi-agent system for generating professional investment memos using LangGraph and Claude.

This release delivers a **comprehensive citation pipeline overhaul** that fixes a multi-week issue where citation definitions were being lost during processing, breaking footnote anchor links in final output. It also introduces **screenshot optimization** to significantly reduce exported file sizes.

---

## What's New in v0.4.1

### Citation Pipeline Overhaul

A critical bug was causing citation definitions (`[^1]: Source...`) to be lost while inline markers (`[^1]`) remained, resulting in broken footnote links in exported memos. This release completely overhauls the citation pipeline with multiple layers of protection.

**Root Causes Fixed:**

| Issue | Cause | Fix |
|-------|-------|-----|
| Definitions lost during polishing | Writer validated `### Citations` header existed but not definition content | Added definition count validation with fallback |
| Duplicate citation keys | Perplexity outputs multiple `[^3]:` definitions | New function renumbers to unique sequential keys |
| Late hallucination detection | Invalid URLs caught at assembly (too late) | Two-gate validation kills hallucinations early |
| Alphanumeric citations ignored | `[^deck]` keys not handled by renumbering | Extended regex to support `[a-zA-Z0-9_]` keys |

**New: Two-Gate Validation Architecture**

Hallucinated citations are now caught at two points in the pipeline:

```
Research Phase → [GATE 1] → Writer → Enrichment → [GATE 2] → Assembly → Final Draft
                    ↓                                  ↓
            Validates 1-research/              Validates 2-sections/
            Removes 404s, fakes                Removes 404s, fakes
```

- **Gate 1** (`cleanup_research_citations`): Runs after research, BEFORE writer sees the content
- **Gate 2** (`cleanup_sections_citations`): Runs after enrichment, BEFORE final assembly

This prevents false information from ever entering the draft narrative.

**Writer Definition Preservation:**

```python
# Before: Only checked if "### Citations" header existed (could be empty!)
# After: Validates actual definition count

defs_before = count_definitions(research_content)
defs_after = count_definitions(polished_content)

if defs_after == 0 and defs_before > 0:
    return original_research  # Fallback to preserve citations
```

**Perplexity Duplicate Key Handling:**

```python
# Before (Perplexity output):
# [^3]: Source A...
# [^3]: Source B...
# [^3]: Source C...
# Inline: claims [^3]

# After (fixed):
# [^3]: Source A...
# [^4]: Source B...
# [^5]: Source C...
# Inline: claims [^3] [^4] [^5]
```

---

### Screenshot Optimization

Pitch deck screenshots were being saved at full resolution, resulting in 70MB+ exports for a single memo.

**Fix:** Screenshots are now automatically resized to max 1200px width while maintaining aspect ratio.

```python
# New parameter with sensible default
def extract_deck_screenshots(..., max_width: int = 1200):
    # Resize if width exceeds max_width
    if width > max_width:
        ratio = max_width / width
        new_height = int(height * ratio)
        img = img.resize((max_width, new_height), Image.Resampling.LANCZOS)
```

**Impact:**
- **Before**: 70MB+ per memo export
- **After**: ~10-15MB per memo export (5-7x reduction)
- Quality maintained for document viewing (1200px is ample for PDFs/web)

---

### New Agents

| Agent | Purpose |
|-------|---------|
| `src/agents/remove_invalid_sources.py` | URL validation with parallel HTTP HEAD requests, hallucination pattern detection |
| `src/agents/citation_assembly.py` | Dedicated citation assembly and consolidation logic |
| `src/agents/inject_deck_images.py` | Inject pitch deck screenshots into appropriate sections |

---

## Testing Results

Tested on ProfileHealth memo generation:

| Stage | Citations |
|-------|-----------|
| Research phase | 84 citations generated |
| Gate 1 (post-research) | 6 invalid removed → 78 remaining |
| Writer | All definitions preserved ✓ |
| Citation enrichment | 262 → 30 unique |
| Gate 2 (post-enrichment) | 15 invalid removed (404s) |
| **Final output** | **13 citations with working anchor links** |

---

## Usage

No changes to CLI usage. Improvements are automatic in the pipeline.

```bash
# Generate memo (citation fixes applied automatically)
python -m src.main "Company" --firm hypernova

# Export to PDF (smaller file size now)
python cli/export_branded.py --firm hypernova --deal Company --pdf
```

---

## Installation

```bash
git clone https://github.com/lossless-group/investment-memo-orchestrator.git
cd investment-memo-orchestrator
git checkout v0.4.1

# Setup
uv venv --python python3.11
source .venv/bin/activate
uv pip install -e .

# Configure API keys
cp .env.example .env
# Edit .env with your ANTHROPIC_API_KEY, TAVILY_API_KEY, PERPLEXITY_API_KEY
```

---

## Files Changed Summary

### New Files
| File | Purpose |
|------|---------|
| `src/agents/remove_invalid_sources.py` | URL validation and hallucination detection |
| `src/agents/citation_assembly.py` | Citation assembly logic |
| `src/agents/inject_deck_images.py` | Deck screenshot injection |
| `changelog/2025-12-16_01.md` | Detailed changelog |
| `context-vigilance/Anti-Hallucination-Source-Validation-and-Removal.md` | Spec document |
| `context-vigilance/Faked-Sources-from-Perplexity.md` | Perplexity citation issues |
| `context-vigilance/An-Agent-should-Reorder-and-Organize-Citations-on-Assembly.md` | Citation ordering spec |
| `context-vigilance/issue-resolution/Correct-Citation-Pipeline-Accuracy-in-Multi-Agent-Research.md` | Issue resolution doc |

### Modified Files
| File | Change |
|------|--------|
| `src/agents/writer.py` | Citation definition validation, image embed preservation |
| `src/agents/perplexity_section_researcher.py` | Duplicate citation key handling |
| `src/agents/citation_enrichment.py` | Alphanumeric citation support, deduplication |
| `src/agents/citation_validator.py` | Enhanced validation |
| `src/agents/deck_analyst.py` | Screenshot resizing (max 1200px width) |
| `src/workflow.py` | Two-gate validation architecture |
| `README.md` | Updated documentation |

---

## Bug Fixes

| Issue | Fix |
|-------|-----|
| Citation definitions lost during polishing | Added definition count validation with fallback to original |
| Perplexity duplicate citation keys (`[^3]:` repeated) | Renumber to unique sequential keys, expand inline refs |
| Alphanumeric citations not renumbered | Extended regex to match `[^deck]`, `[^ehrtime]`, etc. |
| Hallucinated URLs in final output | Two-gate validation removes invalid URLs early |
| Image embeds removed during polishing | Added image preservation validation |
| Screenshot files too large (70MB+) | Resize to max 1200px width |
| pdf2image empty result crash | Fallback to PyMuPDF if pdf2image returns empty |

---

## Breaking Changes

None. All changes are backward compatible and automatically applied during memo generation.

---

## Technical Details

### Citation Definition Regex
```python
# Matches both numeric and alphanumeric citation keys
r'^\[\^[a-zA-Z0-9_]+\]:'  # [^1]:, [^deck]:, [^ehrtime]:
```

### Validation Fallback Logic
1. Count definitions before polishing
2. Count definitions after polishing
3. If definitions dropped to 0 → use original research
4. If definitions dropped by >50% → use original research
5. Otherwise → accept polished content

### Image Resize Algorithm
```python
if width > max_width:
    ratio = max_width / width
    new_height = int(height * ratio)
    img = img.resize((max_width, new_height), Image.Resampling.LANCZOS)
```

---

## Requirements

- Python 3.11+
- `uv` package manager (NOT pip)
- API keys: Anthropic (required), Tavily (recommended), Perplexity (recommended)
- System dependencies: Pandoc, Poppler (for PDF screenshots)

---

## Documentation

- **Setup**: See `README.md`
- **Architecture**: See `CLAUDE.md`
- **Citation Pipeline**: See `changelog/2025-12-16_01.md`
- **Anti-Hallucination**: See `context-vigilance/Anti-Hallucination-Source-Validation-and-Removal.md`

---

## Acknowledgments

Built with:
- **Claude Opus 4.5 / Sonnet 4.5** (LLM)
- **LangGraph** (orchestration)
- **Tavily** (web search)
- **Perplexity Sonar Pro** (citation enrichment)
- **WeasyPrint** (PDF export)
- **Pandoc** (document conversion)

---

**Need help?** Open an issue or see [CLAUDE.md](./CLAUDE.md) for detailed usage instructions.
