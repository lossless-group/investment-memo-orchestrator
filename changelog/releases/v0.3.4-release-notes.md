# Release v0.3.4

**Investment Memo Orchestrator** - Multi-agent system for generating professional investment memos using LangGraph and Claude.

This release introduces the **Internal Comments Sanitizer** - a new agent and CLI tool that detects and extracts leaked LLM process commentary from generated memos, producing clean, shareable outputs while preserving useful internal notes separately.

---

## What's New in v0.3.4

### Internal Comments Sanitizer

LLMs have a tendency to include meta-commentary in generated content despite aggressive prompt engineering. Phrases like "Let me search for...", "Note: Unable to find...", and "If you have the actual content, please share..." leak into final output and are inappropriate for external-facing documents.

**New Agent:** `src/agents/internal_comments_sanitizer.py`
**New CLI:** `cli/sanitize_commentary.py`

**Features:**
- Detects 15+ patterns of leaked LLM commentary
- Extracts internal notes to separate `2-sections-internal/` folder
- Consolidates process notes into `4-internal-notes.md`
- Automatically reassembles clean final draft after sanitization
- Preview mode to see what would be extracted without modifying files

**Detected Patterns:**
| Pattern Type | Example |
|--------------|---------|
| Process Narration | "Let me search for more information..." |
| Capability Caveats | "Note: Unable to verify this claim..." |
| User Instructions | "Please share the actual content..." |
| Search Announcements | "I'll research the competitive landscape..." |
| Placeholder Content | "[Insert company metrics here]" |
| Conditional Statements | "If you provide the financials, I can..." |
| Internal Reasoning | "Based on my analysis, it appears..." |

**Usage:**
```bash
# Sanitize a memo
python cli/sanitize_commentary.py --firm hypernova --deal Blinka

# Preview what would be extracted without modifying
python cli/sanitize_commentary.py --firm hypernova --deal Blinka --preview

# Specify version
python cli/sanitize_commentary.py --firm dark-matter --deal Reson8 --version v0.0.3

# Legacy mode (non-firm-scoped)
python cli/sanitize_commentary.py "Avalanche"
```

**Output Structure:**
```
output/Company-v0.0.1/
├── 2-sections/                    # Clean, sanitized sections
│   ├── 01-executive-summary.md
│   └── ...
├── 2-sections-internal/           # Extracted commentary (NEW)
│   ├── 01-executive-summary.md
│   └── ...
├── 4-final-draft.md               # Clean, reassembled draft
└── 4-internal-notes.md            # Consolidated internal notes (NEW)
```

**Example Output:**
```
Sanitizing commentary in: io/dark-matter/deals/Reson8/outputs/Reson8-v0.0.3

Processing 10 sections...
  01-executive-summary.md: 2 items extracted
  03-opening.md: 1 item extracted
  08-12ps-scorecard-summary.md: 1 item extracted

✓ Sanitization complete
  Sections processed: 10
  Items extracted: 4
  Internal notes: 4-internal-notes.md

✓ Final draft reassembled: 4-final-draft.md
```

---

### Entity Disambiguation

Companies with common names often appear alongside wrong entities in search results. The new `disambiguation` field in deal configuration files allows you to specify URLs of wrong entities to exclude from research.

**Configuration:**
```json
{
  "name": "Reson8",
  "url": "https://reson8.xyz/",
  "disambiguation": [
    "https://www.reson8.group/",
    "https://www.reson8media.com/",
    "https://reson8sms.com/"
  ]
}
```

**How it works:**
- Research agents receive disambiguation URLs as exclusion context
- Perplexity section researcher adds exclusion block to prompts
- Section improvement CLI respects disambiguation when researching
- Prevents entity confusion in multi-entity search results

---

### Trademark Path Resolution Fix

Fixed an issue where company trademarks weren't appearing in HTML exports for firm-scoped deals.

**Problem:** Trademark paths in deal JSON files weren't being resolved relative to the deal directory.

**Solution:** Added path resolution logic in `src/main.py` that:
1. Checks if trademark path exists as absolute path
2. If not, resolves relative to deal directory (`io/{firm}/deals/{deal}/`)
3. Works for both `trademark_light` and `trademark_dark` fields

**Example:**
```json
{
  "trademark_dark": "inputs/trademark__Company--Dark-Mode.png"
}
```
Now correctly resolves to `io/firm/deals/Company/inputs/trademark__Company--Dark-Mode.png`.

---

## Usage Examples

### Post-Generation Cleanup Workflow

```bash
# 1. Generate memo
python -m src.main "Company" --firm hypernova

# 2. Sanitize any leaked LLM commentary
python cli/sanitize_commentary.py --firm hypernova --deal Company

# 3. Review internal notes (useful feedback, data gaps)
cat io/hypernova/deals/Company/outputs/Company-v0.0.1/4-internal-notes.md

# 4. Export clean memo to PDF
python cli/export_branded.py --firm hypernova --deal Company --pdf
```

### Preview Before Sanitizing

```bash
# See what would be extracted without modifying files
python cli/sanitize_commentary.py --firm dark-matter --deal Reson8 --preview

# Output shows:
#   01-executive-summary.md:
#     - [process_narration] "Let me search for more specific information..."
#     - [user_instruction] "Note: This section does not contain..."
```

---

## Installation

```bash
git clone https://github.com/lossless-group/investment-memo-orchestrator.git
cd investment-memo-orchestrator
git checkout v0.3.4

# Setup
uv venv --python python3.11
source .venv/bin/activate
uv pip install -e .

# Configure API keys
cp .env.example .env
# Edit .env with your ANTHROPIC_API_KEY, TAVILY_API_KEY, PERPLEXITY_API_KEY
```

---

## Files Changed Summary

### New Files
| File | Purpose |
|------|---------|
| `src/agents/internal_comments_sanitizer.py` | Core sanitization agent with 15+ regex patterns |
| `cli/sanitize_commentary.py` | CLI for running sanitization on existing memos |
| `context-vigilance/Containerizing-Internal-Comments-and-Recommendations-for-Consideration.md` | Specification document |
| `context-vigilance/Disambiguation-Management-across-Agents.md` | Disambiguation feature spec |

### Modified Files
| File | Change |
|------|--------|
| `src/main.py` | Trademark path resolution for firm-scoped mode |
| `src/state.py` | Added `disambiguation_excludes` field to MemoState |
| `src/workflow.py` | Pass disambiguation through generate_memo() |
| `src/agents/research_enhanced.py` | Build exclusion block from disambiguation URLs |
| `src/agents/perplexity_section_researcher.py` | Add exclusion block to research prompts |
| `cli/improve_section.py` | Respect disambiguation when improving sections |
| `README.md` | Added sanitizer docs, updated roadmap and references |

---

## Bug Fixes

| Issue | Fix |
|-------|-----|
| Company trademark not appearing in HTML export | Added path resolution for firm-scoped trademark paths |
| Wrong entities appearing in research results | Added disambiguation URL exclusion support |
| Leaked LLM commentary in final output | New sanitizer agent extracts to internal notes |

---

## Breaking Changes

None. All changes are backward compatible:
- Sanitizer is opt-in via CLI (not part of default pipeline)
- Disambiguation is optional in deal JSON files
- Trademark path resolution falls back to original behavior if path exists

---

## Requirements

- Python 3.11+
- `uv` package manager (NOT pip)
- API keys: Anthropic (required), Tavily (recommended), Perplexity (optional)
- WeasyPrint dependencies (for PDF export)
- Pandoc (for HTML conversion)

---

## Documentation

- **Setup**: See `README.md`
- **Architecture**: See `CLAUDE.md`
- **Firm-Scoped IO**: See `io/README.md`
- **Sanitizer Spec**: See `context-vigilance/Containerizing-Internal-Comments-and-Recommendations-for-Consideration.md`
- **Disambiguation Spec**: See `context-vigilance/Disambiguation-Management-across-Agents.md`

---

## Acknowledgments

Built with:
- **Claude Opus 4.5 / Sonnet 4.5** (LLM)
- **LangGraph** (orchestration)
- **Tavily** (web search)
- **Perplexity Sonar Pro** (citation enrichment)
- **WeasyPrint** (PDF export)
- **Pandoc** (document conversion)

---

**Need help?** Open an issue or see [CLAUDE.md](./CLAUDE.md) for detailed usage instructions.
